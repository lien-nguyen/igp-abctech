pipeline
{
    agent any 
    tools 
    {
        maven 'Maven-3.9.10'
    }
    stages 
    {
        stage('Code Checkout') 
        {
            steps 
            {
                echo 'Checking out code...'
                git branch: 'main', url: 'https://github.com/lien-nguyen/igp-abctech.git'
            }
        }
        stage('Code Compile') 
        {
            steps 
            {
                echo 'Compiling...'
                sh 'mvn compile'
            }
        }
        stage('Unit Test') 
        {
            steps 
            {
                echo 'Testing...'
                sh 'mvn test'
            }
        }
        stage('Code Packaging') 
        {
            steps 
            {
                echo 'Packaging...'
                sh 'mvn package'
            }
        }
        stage('Transfer to Docker Host') 
        {
            steps 
            {
                echo 'Transferring files to Docker host...'
                // Transfer WAR file and Dockerfile to Docker host
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'dockerhost',
                            transfers: [
                                sshTransfer(
                                    sourceFiles: 'target/*.war',
                                    remoteDirectory: 'build',
                                    execCommand: 'mkdir -p /home/dockeradmin/build'
                                ),
                                sshTransfer(
                                    sourceFiles: 'Dockerfile.tomcat',
                                    remoteDirectory: 'build'
                                )
                            ]
                        )
                    ]
                )
            }
        }
        stage('Build Docker Image') 
        {
            steps 
            {
                echo 'Building Docker image on Docker host...'
                // Build Docker image on Docker host
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'dockerhost',
                            transfers: [
                                sshTransfer(
                                    execCommand: '''
                                        cd /home/dockeradmin/build
                                        echo "Building Docker image v1..."
                                        docker build -f Dockerfile.tomcat -t abctech-app:v1 .
                                        echo "Docker image built successfully!"
                                        docker images | grep abctech-app
                                    '''
                                )
                            ]
                        )
                    ]
                )
            }
        }
        stage('Deploy Container') 
        {
            steps 
            {
                echo 'Deploying container on Docker host...'
                // Deploy container on Docker host
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'dockerhost',
                            transfers: [
                                sshTransfer(
                                    execCommand: '''
                                        echo "Stopping old container..."
                                        docker stop abctech-v1-container || true
                                        docker rm abctech-v1-container || true
                                        
                                        echo "Starting new v1 container..."
                                        docker run -d -p 8080:8080 --name abctech-v1-container abctech-app:v1
                                        
                                        echo "Container deployed successfully!"
                                        docker ps | grep abctech-v1-container
                                        
                                        echo "Application available at: http://172.31.20.154:8080/ABCtechnologies-1.0/"
                                    '''
                                )
                            ]
                        )
                    ]
                )
            }
        }
        stage('Push to Docker Hub') 
        {
            steps 
            {
                echo 'Pushing image to Docker Hub...'
                // Tag and push image to Docker Hub with credentials
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'dockerhost',
                            transfers: [
                                sshTransfer(
                                    execCommand: '''
                                        cd /home/dockeradmin/build
                                        echo "Tagging image for Docker Hub..."
                                        docker tag abctech-app:v1 thibichliennguyen/abctech-app:v1
                                        docker tag abctech-app:v1 thibichliennguyen/abctech-app:latest
                                        
                                        echo "Image tagged successfully!"
                                        docker images | grep thibichliennguyen/abctech-app
                                    '''
                                )
                            ]
                        )
                    ]
                )
            }
        }
        stage('Docker Hub Login & Push') 
        {
            steps 
            {
                echo 'Logging into Docker Hub and pushing...'
                // Login and push using Jenkins credentials
                script {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', 
                                                    passwordVariable: 'DOCKER_PASSWORD', 
                                                    usernameVariable: 'DOCKER_USERNAME')]) {
                        sshPublisher(
                            publishers: [
                                sshPublisherDesc(
                                    configName: 'dockerhost',
                                    transfers: [
                                        sshTransfer(
                                            execCommand: """
                                                echo "Logging into Docker Hub..."
                                                echo '$DOCKER_PASSWORD' | docker login -u '$DOCKER_USERNAME' --password-stdin
                                                
                                                echo "Pushing to Docker Hub..."
                                                docker push thibichliennguyen/abctech-app:v1
                                                docker push thibichliennguyen/abctech-app:latest
                                                
                                                echo "Image successfully pushed to Docker Hub!"
                                                echo "Docker Hub URL: https://hub.docker.com/r/thibichliennguyen/abctech-app"
                                                
                                                echo "Logging out from Docker Hub..."
                                                docker logout
                                            """
                                        )
                                    ]
                                )
                            ]
                        )
                    }
                }
            }
        }
    }
}